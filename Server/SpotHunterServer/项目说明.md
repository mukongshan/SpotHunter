# SpotHunterServer 项目说明

## 1. 项目概览
“景区打卡小程序”服务端，提供用户登录、景点地图、打卡积分、打卡历史以及后台流水查询等接口，配合鸿蒙端/Web 前端演示完整的景区打卡体验。项目基于 Spring Boot 4 + Spring Data JPA，数据库为 MySQL。

## 2. 技术栈
- **语言 / 运行环境**：Java 21、Spring Boot 4.0
- **依赖框架**：Spring Web MVC、Spring Data JPA、Jakarta Validation
- **数据库**：MySQL 8.x（无需其他数据库，脚本/data.sql 支持初始化景点数据）
- **构建工具**：Maven（内置 `mvnw`）

## 3. 核心目录结构
```
src/
└─ main/
   ├─ java/org/backend/spothunterserver/
   │  ├─ controller/       # 控制器：暴露 REST API，处理入参校验与响应封装
   │  │   ├─ UserController / SpotController / CheckInController
   │  ├─ service/          # 业务层：CheckInService 负责打卡流程、积分更新、列表聚合
   │  ├─ repository/       # 数据访问层：JPA Repository，封装用户/景点/打卡表查询
   │  ├─ entity/           # 实体映射：User / Spot / CheckIn 对应三张业务表
   │  ├─ dto/              # DTO：接口的请求/响应载体（UserLoginRequest、CheckInHistoryItem 等）
   │  ├─ config/           # 全局配置（异常处理等）
   │  └─ SpotHunterServerApplication.java  # Spring Boot 启动入口
   └─ resources/
      ├─ application.properties  # MySQL 连接、JPA 行为、日志等级
      └─ data.sql                # 初始化景点数据的脚本（INSERT ... ON DUPLICATE KEY）
```

### 各层作用
- **controller**：集中处理 HTTP 请求；`@CrossOrigin("*")` 允许鸿蒙/网页跨域访问；统一返回 `ApiResponse<...>`。
- **service**：封装业务规则。例如 `CheckInService` 校验用户/景点、限制每日重复打卡、累加积分、转换展示所需的历史记录/后台流水 DTO。
- **repository**：使用 Spring Data JPA 快速声明查询方法（如 `findByUsernameIgnoreCase`、`existsByUser_IdAndSpot_Id...`）。
- **entity**：与数据库表一一对应，包含主键策略、默认值、`@PrePersist` 钩子等，保证 ORM 行为与 MySQL 表保持一致。
- **dto**（Data Transfer Object）：明确定义接口输入/输出，避免直接暴露实体字段。
- **config**：`GlobalExceptionHandler` 捕获校验/业务异常，返回一致的错误响应。

## 4. 数据库与初始化
1. 创建数据库（示例）：
   ```sql
   CREATE DATABASE spot_hunter DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```
2. 执行 `src/main/resources/data.sql` 将 5 个示例景点写入 `spot` 表（若主键存在，会更新字段）。
3. MySQL 连接信息在 `application.properties` 中配置，可按需修改：
   ```properties
   spring.datasource.url=jdbc:mysql://localhost:3306/spot_hunter?...
   spring.datasource.username=your_user
   spring.datasource.password=your_password
   spring.jpa.hibernate.ddl-auto=update
   ```

## 5. 启动步骤
1. 保证本地 Java 21、MySQL 服务可用，并已修改 `application.properties`。
2. 在项目根目录执行：
   ```bash
   ./mvnw spring-boot:run   # Windows 可使用 mvnw.cmd
   ```
3. 启动成功后接口基地址为 `http://localhost:8080/api/...`。

## 6. API 摘要

| 模块 | 接口 | 方法 | 描述 |
| --- | --- | --- | --- |
| 用户 | `/api/user/login` | POST | 输入用户名（自动注册或登录），返回用户 ID、积分、头像 URL |
| 用户 | `/api/user/info?userId=` | GET | 查询最新积分（个人中心刷新） |
| 景点 | `/api/spot/list` | GET | 返回所有景点，用于地图撒点/列表 |
| 打卡 | `/api/checkin` | POST | 执行打卡，落库记录并给用户加分 |
| 打卡 | `/api/checkin/my-history?userId=` | GET | 我的足迹（按时间倒序取前 100 条） |
| 后台 | `/api/admin/checkin/all` | GET | 管理端流水（最近 100 条，携带用户名与景点名） |

> 注意：打卡接口默认“作弊模式”——未实现具体距离校验，只要传入 userId/spotId 即视为成功。

## 7. 开发 / 演示建议
- **跨域**：控制器已加 `@CrossOrigin("*")`，适配鸿蒙模拟器与 Web 端请求。
- **自定义景点数据**：可修改 `data.sql` 或直接操作 MySQL，建议使用演示地点附近坐标，提升现场效果。
- **异常提示**：`GlobalExceptionHandler` 会返回 `code=400/500` 与友好提示，前端可直接弹窗展示。
- **扩展方向**：可继续增加管理员登录、景点管理 CRUD、距离算法等，均可在现有分层基础上扩展。

## 8. 常见问题
- **“scale has no meaning for SQL floating point types”**：经纬度字段需使用 `BigDecimal` 或 `DECIMAL(10,6)` 映射。
- **跨域报错**：确认前端请求的实际 Host/Port，必要时在 `@CrossOrigin` 中指定允许的源或在网关设置全局 CORS。
- **MySQL 表名冲突**：若手动修改了表名（如把 `t_user` 改为 `user`），需同步更新实体 `@Table`，并注意 MySQL 关键字。

---
如需进一步扩展（比如 CI/CD、Docker Compose、更多 API 文档），可在此文档基础上追加章节。

